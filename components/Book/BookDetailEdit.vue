<template>
  <a-modal v-model:open="props.openModalEdit" title="Ch·ªânh s·ª≠a s√°ch" :footer="null" :onCancel="handleClose"
    style="width: 1200px;">

    <div class="flex flex-col gap-5 mt-5">
      <div class="border border-t-2"></div>
      <form @submit.prevent="onSubmit">
        <div class="flex flex-col gap-5">
          <div class="grid grid-rows-1">
            <div class="grid grid-cols-2 gap-10">
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">·∫¢nh ch√≠nh</label>
                <ClientOnly>
                  <a-spin tip="ƒêang x·ª≠ l√Ω..." :spinning="baseStore.isSubmitting">
                    <a-upload-dragger v-model:fileList="fileList" list-type="picture" name="image" :multiple="false"
                      :action="(file) => uploadFile(file)" @change="handleChangeImage" @drop="handleDrop"
                      :before-upload="beforeUpload" :remove="(file) => deleteFile(file)">
                      <p class="ant-upload-drag-icon">
                        <inbox-outlined></inbox-outlined>
                      </p>
                      <p class="ant-upload-text">Click ho·∫∑c k√©o th·∫£ file v√†o ƒë√¢y</p>
                      <p class="ant-upload-hint">Ho·∫∑c nh·∫•n v√†o ƒë√¢y ƒë·ªÉ ch·ªçn file</p>
                    </a-upload-dragger>
                  </a-spin>
                </ClientOnly>
              </div>
              <div class="flex flex-col gap-2"><label class="text-sm font-semibold" for="">B·ªô s∆∞u t·∫≠p</label>
                <a-upload list-type="picture" :max-count="3" action="https://www.mocky.io/v2/5cc8019d300000980a055e76">
                  <a-button class="flex justify-between gap-3 items-center">
                    <upload-outlined></upload-outlined>
                    <h1>B·ªô s∆∞u t·∫≠p</h1>
                  </a-button>
                </a-upload>
              </div>
            </div>
          </div>
          <div class="flex flex-col gap-2">
            <label class="text-sm font-semibold" for="">Sku</label>
            <a-input type="text" class="border p-2 rounded-md h-10" placeholder="M√£ s√°ch" v-model:value="data.sku_origin" />
          </div>
          <div class="grid grid-rows-3 gap-5 ">
            <div class="grid grid-cols-4 gap-10">
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Phi√™n b·∫£n s√°ch</label>
                <a-input type="text" class="border p-2 rounded-md h-10" placeholder="Phi√™n b·∫£n s√°ch" v-model:value="data.book_version" />
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">S·ªë l∆∞·ª£ng</label>
                <a-input type="number" class="border p-2 rounded-md h-10" placeholder="S·ªë l∆∞·ª£ng" v-model:value="data.stock" />
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Gi√°</label>
                <a-input type="number" class="border p-2 rounded-md h-10" placeholder="Gi√°" v-model:value="data.price" />
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Ti·ªÅn c·ªçc</label>
                <a-input type="number" class="border p-2 rounded-md h-10" placeholder="Ti·ªÅn c·ªçc" v-model:value="data.hire_percent" />
              </div>
            </div>
            <div class="grid grid-cols-4 gap-10">
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Lo·∫°i b√¨a</label>
                <a-select show-search size="large" placeholder="Lo·∫°i b√¨a" :options="optionsCardboard"
                v-model="data.cardboard"
                  :filter-option="filterOption" @focus="handleFocus" @blur="handleBlur"
                  @change="handleChange"></a-select>
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">S·ªë trang</label>
                <a-input type="number" class="border p-2 rounded-md h-10" placeholder="S·ªë trang" v-model:value="data.total_page" />
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">K√≠ch th∆∞·ªõc s√°ch</label>
                <a-input type="text" class="border p-2 rounded-md h-10" placeholder="K√≠ch th∆∞·ªõc s√°ch" v-model:value="data.book_size" />
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Ng√¥n ng·ªØ</label>
                <a-input type="text" class="border p-2 rounded-md h-10" placeholder="Ng√¥n ng·ªØ" v-modeal:value="data.language"/>
              </div>
            </div>
            <div class="grid grid-cols-4 gap-10">
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Ng∆∞·ªùi bi√™n d·ªãch</label>
                <a-input type="text" class="border p-2 rounded-md h-10" placeholder="Ng∆∞·ªùi bi√™n d·ªãch" v-model:value="data.translator"/>
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Ng√†y ph√°t h√†nh</label>
                <a-input type="date" class="border p-2 rounded-md h-10" placeholder="Ng√†y ph√°t h√†nh"  v-model:value="data.publish_date"/>
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">C√¥ng ty ph√°t h√†nh</label>
                <a-input type="text" class="border p-2 rounded-md h-10" placeholder="C√¥ng ty ph√°t h√†nh" v-model:value="data.issuing_company" />
              </div>
              <div class="flex flex-col gap-2">
                <label class="text-sm font-semibold" for="">Nh√† xu·∫•t b·∫£n</label>
                <a-select size="large" show-search placeholder="Nh√† xu·∫•t b·∫£n" :options="optionsPublishingcompany"
                v-model:value="data.publishing_company"
                  :filter-option="filterOption" @focus="handleFocus" @blur="handleBlur"
                  @change="handleChange"></a-select>
              </div>
            </div>
          </div>
        </div>
        <div class="flex justify-end items-end gap-2">
          <a-button @click="handleClose" html-type="button">H·ªßy</a-button>
          <a-button type="primary" html-type="submit" class="mt-4">L∆∞u thay ƒë·ªïi</a-button>
        </div>
      </form>
    </div>
  </a-modal>
</template>

<script setup>
const props = defineProps({
  openModalEdit: Boolean,
  openModal: Function,
  book_detail: Number,
});
const idBookDetail = ref(props.book_detail);

const open = ref(props.openModalEdit);
watch(
  () => props.openModalEdit,
  (newVal) => {
    open.value = newVal;
  }
);
watch(
  () => props.book_detail,
  (newVal) => {
    idBookDetail.value = newVal;
  }
);
const baseStore = useBaseStore();
const fileList = ref([]);
const imageInfo = ref("");
const uploadFile = async (file) => {
  if (fileList.value.length > 0) {
    fileList.value = [];
    await baseStore.deleteImg(imageInfo.value?.publicId);
  }
  const formData = new FormData();
  formData.append("image", file);
  try {
    const dataUpload = await baseStore.uploadImg(formData);
    imageInfo.value = dataUpload.data._rawValue.data;
  } catch (error) {
    message.error("Upload ·∫£nh th·∫•t b·∫°i");
    console.log("üöÄ ~ uploadFile ~ error:", error);
  }
};
const handleChangeImage = (info) => {
  const status = info.file.status;
  if (status !== "uploading") {
    console.log(info.file, info.fileList);
  }
  if (status === "done") {
    message.success(`${info.file.name} file uploaded successfully.`);
  } else if (status === "error") {
    message.error(`${info.file.name} file upload failed.`);
  }
};
const deleteFile = async (file) => {
  await baseStore.deleteImg(file.url.split("/").pop().split(".")[0]);
};

const beforeUpload = (file) => {
  const isImage = file.type.startsWith("image/");
  if (!isImage) {
    message.error("B·∫°n ch·ªâ c√≥ th·ªÉ t·∫£i l√™n file ·∫£nh!");
  }
  return isImage || Upload.LIST_IGNORE;
};
const handleClose = () => {
  open.value = false;
  props.openModal(false);
};

const bookDetailStore = useBookDetailStore();
const optionsCardboard = ref([
  {
    value: "soft",
    label: "B√¨a m·ªÅm",
  },
  {
    value: "hard",
    label: "B√¨a c·ª©ng",
  },
]);
const optionsPublishingcompany = ref([]);
const publishingcompanyValue = usePublishingCompanyStore();
useAsyncData(async () => {
  try {
    const data = await publishingcompanyValue.getAllPublishingCompany({});
    optionsPublishingcompany.value = data.data._rawValue.data.publishing_companies.map((publishingcompany) => {
      return {
        value: publishingcompany.id,
        label: publishingcompany.name,
      };
    })
  } catch (error) {
    console.error(error);
  }
});
const data = ref(
  {
    sku_origin: "", 
    book_version: "",
    stock: "",
    price: "",
    hire_percent: "",
    cardboard: "",
    total_page: "",
    book_size: "",
    language: "",
    translator: "",
    publish_date: "",
    issuing_company: "",
    publishing_company: ""

  }
)

useAsyncData(async () => {
  const res = await bookDetailStore.getOneBookDetail(idBookDetail.value);
  data.value.sku_origin = res.data._rawValue.data.sku_origin;
  data.value.book_version = res.data._rawValue.data.book_version;
  data.value.stock = res.data._rawValue.data.stock;
  data.value.price = res.data._rawValue.data.price;
  data.value.hire_percent = res.data._rawValue.data.hire_percent;
  data.value.cardboard = res.data._rawValue.data.cardboard;
  data.value.total_page = res.data._rawValue.data.total_page;
  data.value.book_size = res.data._rawValue.data.book_size;
  data.value.language = res.data._rawValue.data.language;
  data.value.translator = res.data._rawValue.data.translator;
  data.value.publish_date = res.data._rawValue.data.publish_date;
  data.value.issuing_company = res.data._rawValue.data.issuing_company;
  data.value.publishing_company = res.data._rawValue.data.publishing_company.name;
});


</script>